C51 COMPILER V9.00   LED                                                                   05/13/2018 21:45:16 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE LED
OBJECT MODULE PLACED IN LED.OBJ
COMPILER INVOKED BY: D:\51\C51\BIN\C51.EXE LED.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*-----------------------------------------------
   2          名称：数码管显示红外遥控器中(1-9)键值
   3          
   4          内容：按配套遥控器上的1-9按键会在数码管上对应显示,注意其它按键没有反应的。
   5          ------------------------------------------------*/
   6          #include<reg52.h>
   7          #define uint unsigned int
   8          #define uchar unsigned char   
   9          
  10          sbit ir=P3^2;
  11          sbit LED_GPIO=P3^4;  
  12          sfr P3M0 = 0xB2;
  13          sfr P3M1 = 0xB1;
  14          
  15          bit time_start = 0;
  16          uchar time_10ms_flag=0;
  17          uchar time_10ms=0;
  18          uchar time_s=0;
  19          uchar time_min=0;
  20          uchar time_hour=0; 
  21          
  22          #define set_time 10
  23          uchar irtime;
  24          bit irprosok,irok;
  25          uchar irtime;
  26          
  27          
  28          uchar ircode[4];
  29          uchar irdata[33];
  30          uchar startflag;
  31          uchar  bitnum;
  32          
  33          void sys_init(void);
  34          void GPIO_init(void);
  35          void timer0init(void);
  36          void int0init(void);
  37          
  38          void sys_init()
  39          {
  40   1         int0init(); //初始化外部中断
  41   1         timer0init();//初始化定时器
  42   1         GPIO_init();
  43   1      }
  44          
  45          void GPIO_init(void)
  46          {
  47   1       P3M0 = 0x10;            //P3.4强推挽输出
  48   1       P3M1 = 0x00;            //P3.4强推挽输出
  49   1       LED_GPIO = 0;
  50   1      }
  51          
  52          void timer0init(void)//定时器0初始化 256*(1/12m)*12=0.256ms
  53          {
  54   1        TMOD=0x02;//定时器0工作方式2，TH0是重装值，TL0是初值
  55   1        TH0=0x00; //重载值
C51 COMPILER V9.00   LED                                                                   05/13/2018 21:45:16 PAGE 2   

  56   1        TL0=0x00; //初始化值
  57   1        ET0=1;    //开中断
  58   1        TR0=1;    
  59   1      }
  60          
  61          
  62          void tim0_isr (void) interrupt 1 using 1  //定时器0中断服务函数
  63          {
  64   1        irtime++;  //用于计数2个下降沿之间的时间
  65   1        
  66   1        if(time_start)
  67   1          time_10ms_flag+=1;
  68   1        if(time_10ms_flag == 39)
  69   1        {
  70   2          time_10ms_flag = 0;
  71   2          time_10ms ++;
  72   2        }
  73   1        if(time_10ms == 100)
  74   1        {
  75   2                time_10ms = 0;
  76   2                time_s++;
  77   2        }
  78   1         if(time_s == 60)
  79   1        {
  80   2                time_s == 0;
*** WARNING C275 IN LINE 80 OF LED.C: expression with possibly no effect
  81   2                time_min ++;  
  82   2        }
  83   1         if(time_min == 60)
  84   1         {
  85   2              time_min = 0;
  86   2              time_hour++;
  87   2         }
  88   1      }
  89          
  90          
  91          void int0init(void)  //外部中断0初始化
  92          {
  93   1       IT0 = 1;   //指定外部中断0下降沿触发，INT0 (P3.2)
  94   1       EX0 = 1;   //使能外部中断
  95   1       EA = 1;    //开总中断
  96   1      }
  97          
  98          
  99          void int0 () interrupt 0 //外部中断0服务函数
 100          {
 101   1      if(startflag)
 102   1       {
 103   2        if(irtime>32&&irtime<63)  //8-16ms
 104   2              {
 105   3                 bitnum=0;
 106   3              }
 107   2              irdata[bitnum]=irtime;
 108   2              irtime=0;
 109   2              bitnum++;
 110   2              if(bitnum==33)
 111   2                {
 112   3                 bitnum=0;
 113   3                 irok=1;
 114   3                }
 115   2       }
 116   1      else
C51 COMPILER V9.00   LED                                                                   05/13/2018 21:45:16 PAGE 3   

 117   1       {
 118   2       irtime=0;
 119   2       startflag=1;
 120   2       }
 121   1      }
 122          
 123          
 124          void irpros(void) // 红外码值处理
 125          {
 126   1              uchar mun,k,i,j;
 127   1              k=1;
 128   1              for(j=0;j<4;j++)
 129   1              {
 130   2                      for(i=0;i<8;i++)
 131   2                      {
 132   3                              mun=mun>>1;
 133   3                              if(irdata[k]>6)
 134   3                              {
 135   4                                      mun=mun | 0x80;
 136   4                              }
 137   3                                      k++;
 138   3                      }
 139   2                      ircode[j]=mun;
 140   2              }
 141   1              irprosok=1;
 142   1      }
 143          
 144          
 145          void ir_work(void) //红外键值处理
 146          {
 147   1              switch(ircode[2])   //判断第三个数码值
 148   1                       {
 149   2                               case 0x0c:LED_GPIO = 1;  break;
 150   2                               case 0x18:LED_GPIO = 0;  break;//2
 151   2                               case 0x5e:time_start = 1;break;//3
 152   2                               case 0x08:
 153   2                               time_start = 0;
 154   2                               time_10ms_flag =0;
 155   2                               time_10ms=0;
 156   2                               time_s=0;
 157   2                               time_min=0;
 158   2                               time_hour=0;
 159   2                               break;//4
 160   2      //                       case 0x1c:P0=table_du[5];break;//5
 161   2      //                       case 0x5a:P0=table_du[6];break;//6
 162   2      //                       case 0x42:P0=table_du[7];break;//7
 163   2      //                       case 0x52:P0=table_du[8];break;//8
 164   2      //                       case 0x4a:P0=table_du[9];break;//9
 165   2                   default:break;
 166   2                               }
 167   1                        irprosok=0;//处理完成标志
 168   1        }
 169          
 170          
 171          void main(void)
 172          {
 173   1       sys_init();//系统初始化
 174   1       while(1)//主循环
 175   1         {
 176   2          if(irok)       //如果接收好了进行红外处理
 177   2                {   
 178   3                 irpros();
C51 COMPILER V9.00   LED                                                                   05/13/2018 21:45:16 PAGE 4   

 179   3                 irok=0;
 180   3                }
 181   2          if(irprosok)  //如果处理好后进行工作处理
 182   2                {
 183   3                 ir_work();
 184   3                }
 185   2          if(time_s==10)      LED_GPIO=1;  
 186   2         }
 187   1      }
 188            
 189            


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    270    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     45    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
